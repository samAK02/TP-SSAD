<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SSAD mails</title>
  <link rel="icon" href="{{ url_for('static', filename='tof (1).png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='messages.css') }}">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

  <style>
    /* --- Icônes Material --- */
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
      font-size: 20px;
      margin-right: 8px;
      vertical-align: middle;
    }

    /* --- Boutons généraux --- */
    button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      margin: 4px 0;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    /* ============================== */
    /*         SIDEBAR STYLE          */
    /* ============================== */

    .sidebar {
      width: 190px;
      background: #fff;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      transition: width 0.25s ease;
      overflow: hidden;
    }

    .sidebar.collapsed {
      width: 70px;
    }

    .top-section {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .menu-icon { cursor: pointer; margin-left: 10px; }

    .logo {
      font-size: 18px;
      font-weight: bold;
      
      height: 50px;
    }

    .sidebar.collapsed .logo { display: none; }

    .nav-buttons {
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 6px;
    }

    .nav-buttons button {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      padding: 8px 12px;
      border: none;
      background: none;
      color: #202124;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s ease;
    }

    .nav-buttons button:hover {
      background: #e8f0fe;
      color: #1a73e8;
    }

    .sidebar.collapsed .label { display: none; }

    .user-info {
      margin-top: auto;
      padding: 12px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #5f6368;
      overflow: hidden;
    }

    .sidebar.collapsed #usernmee { display: none; }

    .main-content { flex: 1; padding: 20px; }
    .container { display: flex; height: 100vh; }


     
    #sendMessageForm{
      display: flex;
      flex-direction: column;
      gap: 13px;
    }
     
    #sendMessageForm textarea{
      border: 2px solid black;
      border-radius: 20px;
      width: 50%;
      height: 200px;
    }
    #sendMessageForm #to{
       border: 2px solid black;
      border-radius: 20px;
      width: 50%;
      height: 30px;
    }
    #sendMessageForm button{
      width: 100px;
    }

    /* === MODAL === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.3s ease forwards;
    }

    .modal-box {
      background: #fff;
      padding: 25px 30px;
      border-radius: 14px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      text-align: center;
      width: 360px;
      animation: scaleIn 0.3s ease;
    }

    .modal-box select, .modal-box input {
      width: 80%;
      padding: 8px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .modal-actions {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }

    .modal-actions button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .modal-actions button.cancel {
      background: #ccc;
    }

    .modal-actions button#confirmEncryptionBtn {
      background: #007bff;
      color: #fff;
    }




    .time-info {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  justify-content: center;
  font-size: 13px;
  color: #555;
}
.time-info .material-symbols-outlined {
  font-size: 16px;
  line-height: 1;
  vertical-align: middle;
}


/* === STÉGANOGRAPHIE === */
.stegano-container {
  max-width: 600px;
  margin: auto;
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.tab-header {
  display: flex;
  justify-content: space-around;
  margin-bottom: 20px;
  border-bottom: 2px solid #ddd;
}

.tab-btn {
  flex: 1;
  padding: 10px;
  border: none;
  background: none;
  cursor: pointer;
  font-weight: bold;
  transition: 0.2s;
}

.tab-btn.active {
  color: #007bff;
  border-bottom: 3px solid #007bff;
}

.tab-pane {
  display: none;
  text-align: center;
}

.tab-pane.active {
  display: block;
}

.tab-pane input, .tab-pane textarea {
  width: 80%;
  margin-top: 10px;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.tab-pane button {
  margin-top: 12px;
  padding: 8px 14px;
}





    @keyframes fadeIn {
      from { opacity: 0; } to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Cardo:ital,wght@0,400;0,700;1,400&family=Italianno&family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">

</head>

<body>
  <div class="container">
    <div class="sidebar collapsed" id="sidebar">
      <div class="top-section">
        <span id="toggleSidebar" class="material-symbols-outlined menu-icon">
view_headline
</span>
       
        <div class="logo" style="display: flex;flex-direction: row;align-items: center;justify-content: center;"><h2>SSAD</h2><div style="font-family: 'Italianno', cursive;font-size: 20px;">mails</div></div>

      </div>

      <nav class="nav-buttons">
        <button id="writeBtn"><span class="material-symbols-outlined">edit_square</span><span class="label">Write</span></button>
        <button id="sentBtn"><span class="material-symbols-outlined">send</span><span class="label">Sent</span></button>
        <button id="receivedBtn"><span class="material-symbols-outlined">move_to_inbox</span><span class="label">Received</span></button>
        <button id="stegano"><span class="material-symbols-outlined">mail_shield</span><span class="label">Steganography</span></button>
        <button id="attaque"><span class="material-symbols-outlined">skull</span><span class="label">Attaques</span></button>

       
        <button id="search"><span class="material-symbols-outlined">search</span><span class="label">Search</span></button>

        <button id="logoutBtn"><span class="material-symbols-outlined">logout</span><span class="label">Logout</span></button>
      </nav>

      <div class="user-info" style="display: flex;flex-direction: row;">
        <span class="material-symbols-outlined">account_circle</span>
        <h3 id="usernmee" style="  margin: 0 !important;
  padding: 0 !important;"></h3>
      </div>
    </div>

    <div class="main-content" id="mainContent">
      <h2>Welcome to your mailbox!</h2>
      <p>Select a section from the sidebar to view your messages.</p>
    </div>
  </div>

  <!-- === MODAL POPUP === -->
  <div id="encryptionModal" class="modal-overlay">
    <div class="modal-box">
      <h2>Choose Encryption Method</h2>
      <select id="popupEncryptionSelect">
        <option value="">-- Select a method --</option>
        <option value="cesar">César</option>
        <option value="affine">Affine</option>
        <option value="hill">Hill</option>
        <option value="playfair">Playfair</option>
      </select>
      <div id="popupCesarKey" style="display:none;">
        <input type="number" id="popupCesarKeyInput" placeholder="Clé César (ex: 3)">
      </div>
      <div id="popupAffineKeys" style="display:none;">
        <input type="number" id="popupAffineA" placeholder="a (premier avec 224)">
        <input type="number" id="popupAffineB" placeholder="b (décalage)">
      </div>
      
      <div id="popupHillKey" style="display:none;">
        <input type="number" id="popupAffineAhill" placeholder="a (premier avec 224)">
        <input type="number" id="popupAffineBhill" placeholder="b (décalage)">
      </div>

      <div id="popupPlayfairKeys" style="display:none;">
        <input type="number" id="popupAffineAplay" placeholder="a (premier avec 224)">
        <input type="number" id="popupAffineBplay" placeholder="b (décalage)">
      </div>


      <div class="modal-actions">
        <button id="confirmEncryptionBtn">Confirm</button>
        <button class="cancel" id="cancelEncryptionBtn">Cancel</button>
      </div>
    </div>
  </div>














  <script>
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("toggleSidebar");
    toggleBtn.addEventListener("click", () => sidebar.classList.toggle("collapsed"));

    async function checkSession() {
      try {
        const res = await fetch('/api/check_token', { method: 'GET', credentials: 'include' });
        if (!res.ok) { alert('Session expirée'); window.location.href = '/'; }
        const data = await res.json();
        document.getElementById('usernmee').textContent = '@' + data.logged_in_as;
      } catch { alert('Erreur serveur'); window.location.href = '/'; }
    }
    checkSession();









    // === CHIFFREMENT ===
    function cesarChiffrement(txt, k) {
      let res = "", start = 32, end = 255, mod = end - start + 1;
      k = ((k % mod) + mod) % mod;
      for (let ch of txt) {
        const code = ch.charCodeAt(0);
        res += (code >= start && code <= end)
          ? String.fromCharCode(((code - start + k) % mod) + start)
          : ch;
      }
      return res;
    }
    const cesarDechiffrement = (txt, k) => cesarChiffrement(txt, -k);
    const pgcd = (a, b) => b === 0 ? a : pgcd(b, a % b);
    const invMod = (a, m) => { for (let x = 1; x < m; x++) if ((a * x) % m === 1) return x; return null; };

    function affineChiffrement(txt, a, b) {
      const start = 32, end = 255, mod = end - start + 1;
      if (pgcd(a, mod) !== 1) return txt;
      let res = "";
      for (let ch of txt) {
        const code = ch.charCodeAt(0);
        res += (code >= start && code <= end)
          ? String.fromCharCode(((a * (code - start) + b) % mod) + start)
          : ch;
      }
      return res;
    }

    const affineDechiffrement = (txt, a, b) => {
      const start = 32, end = 255, mod = end - start + 1, invA = invMod(a, mod);
      let res = "";
      for (let ch of txt) {
        const code = ch.charCodeAt(0);
        res += (code >= start && code <= end)
          ? String.fromCharCode(((invA * ((code - start - b + mod)) % mod) + start))
          : ch;
      }
      return res;
    };







    
    // === WRITE SECTION ===
    const mainContent = document.getElementById('mainContent');
    document.getElementById('writeBtn').addEventListener('click', () => {
      mainContent.innerHTML = `
        <h2>Compose a Message</h2>
        <form id="sendMessageForm">
          <input type="text" id="to" placeholder="To (username):" required>
          <textarea id="content" placeholder="Your message..." rows="6" required></textarea>
          <button type="submit">Send <span class="material-symbols-outlined">rocket_launch</span></button>
        </form>`;
      attachSendHandler();
    });

    // === OPEN MODAL ===
    function openEncryptionPopup(to, content) {
      const modal = document.getElementById('encryptionModal');
      modal.style.display = 'flex';

      document.getElementById('popupEncryptionSelect').value = '';
      document.getElementById('popupCesarKey').style.display = 'none';
      document.getElementById('popupAffineKeys').style.display = 'none';
      document.getElementById('popupHillKey').style.display = 'none';
      document.getElementById('popupPlayfairKeys').style.display = 'none';
      document.getElementById('popupEncryptionSelect').onchange = e => {
        const val = e.target.value;
        document.getElementById('popupCesarKey').style.display = val === 'cesar' ? 'block' : 'none';
        document.getElementById('popupAffineKeys').style.display = val === 'affine' ? 'block' : 'none';
        document.getElementById('popupHillKey').style.display = val === 'hill' ? 'block' : 'none';
        document.getElementById('popupPlayfairKeys').style.display = val === 'playfair' ? 'block' : 'none';
      };

      document.getElementById('cancelEncryptionBtn').onclick = () => modal.style.display = 'none';
      document.getElementById('confirmEncryptionBtn').onclick = () => sendEncryptedMessage(to, content);
    }


/* ===========================
   SECTIONS SENT & RECEIVED
=========================== */

const sentBtn = document.getElementById("sentBtn");
const receivedBtn = document.getElementById("receivedBtn");
const main = document.getElementById("mainContent");

/* === Charger les messages envoyés === */
sentBtn.addEventListener("click", async () => {
  try {
    const res = await fetch("/api/messages/sent", { credentials: "include" });
    const data = await res.json();
    if (!res.ok) return alert(data.error || "Erreur serveur");

    if (data.messages.length === 0) {
      main.innerHTML = "<h2>Sent Messages</h2><p>Aucun message envoyé.</p>";
      return;
    }

    main.innerHTML = "<h2>Sent Messages</h2>";
    data.messages.forEach(msg => {
      const div = document.createElement("div");
      div.className = "message-box";
      div.innerHTML = `
        <p><strong>To:</strong> ${msg.receiver}</p>
        <p><strong>Content (encrypted):</strong><br><code>${msg.content}</code></p>
<div class="time-info">
  <p>
     <small>
   
      <span class="material-symbols-outlined">schedule</span>
      ${new Date(msg.timestamp).toLocaleString()}
    
  </small>
</p>
</div>
      `;
      main.appendChild(div);
    });
  } catch (err) {
    console.error(err);
    alert("Erreur lors du chargement des messages envoyés");
  }
});

/* === Charger les messages reçus === */
receivedBtn.addEventListener("click", async () => {
  try {
    const res = await fetch("/api/messages", { credentials: "include" });
    const data = await res.json();
    if (!res.ok) return alert(data.error || "Erreur serveur");

    if (data.messages.length === 0) {
      main.innerHTML = "<h2>Received Messages</h2><p>Aucun message reçu.</p>";
      return;
    }

    main.innerHTML = "<h2>Received Messages</h2>";
    data.messages.forEach(msg => {
      const div = document.createElement("div");
      div.className = "message-box";

      div.innerHTML = `
        <p><strong>From:</strong> ${msg.sender}</p>
        <p><strong>Message:</strong><br><code>${msg.content}</code></p>
        <button class="decryptBtn"
                data-meta="${msg.meta}"
                data-content="${msg.content}"
                data-receiver-id="${msg.receiver_id}"
                data-timestamp="${msg.timestamp}">
          <span class="material-symbols-outlined">
lock_open
</span> Decypher
        </button>
        <div class="decrypted"></div>
        
        <p>
  <small>
    <div class="time-info">
      <span class="material-symbols-outlined">schedule</span>
      ${new Date(msg.timestamp).toLocaleString()}
    </div>
  </small>
</p>

      `;
      main.appendChild(div);
    });

    // Attacher les handlers de déchiffrement (version toggle)
document.querySelectorAll(".decryptBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    const div = btn.nextElementSibling;
    const icon = btn.querySelector(".material-symbols-outlined");

    // Vérifie si déjà déchiffré (toggle)
    if (btn.dataset.state === "decrypted") {
      // Cacher le message
      div.innerHTML = "";
      btn.dataset.state = "encrypted";
      icon.textContent = "lock_open"; // cadenas ouvert
      btn.lastChild.textContent = " Decypher"; // texte original
      return;
    }

    // Sinon, déchiffrer normalement
    const metaEnc = btn.dataset.meta;
    const contentEnc = btn.dataset.content;
    const receiverId = parseInt(btn.dataset.receiverId);
    const timestamp = parseInt(btn.dataset.timestamp);

    try {
      const sessionKey = (receiverId * timestamp) % 95;
      const meta = cesarDechiffrement(metaEnc, sessionKey);
      let type = "Inconnu";
      let decrypted = "Impossible de déchiffrer.";

      if (meta.includes("CAESAR-UUID")) {
        const key = parseInt(meta.split("|")[0]);
        decrypted = cesarDechiffrement(contentEnc, key);
        type = "Cesar";
      } else if (meta.includes("AFFINE-UUID")) {
        const [a, b] = meta.split("|")[0].split(",").map(Number);
        decrypted = affineDechiffrement(contentEnc, a, b);
        type = "Affine";
      } else if (meta.includes("HILL-UUID")) {
        decrypted = "[Méthode Hill non implémentée]";
        type = "Hill";
      } else if (meta.includes("PLAYFAIR-UUID")) {
        decrypted = "[Méthode Playfair non implémentée]";
        type = "Playfair";
      }

      div.innerHTML = `
        <p><strong>Decrypted:</strong><br>${decrypted}</p>
        <br>
        <p><strong>Type of encryption:</strong><br>${type}</p>
      `;

      // Mettre à jour le bouton
      btn.dataset.state = "decrypted";
      icon.textContent = "lock"; // cadenas fermé
      btn.lastChild.textContent = " Hide"; // nouveau texte

    } catch (err) {
      div.innerHTML = `<p style="color:red;">Erreur: ${err.message}</p>`;
    }
  });
});



// === SECTION STÉGANOGRAPHIE ===
document.getElementById('stegano').addEventListener('click', () => {
  mainContent.innerHTML = `
    <div class="stegano-container">
      <h2>Steganography Center</h2>

      <!-- Onglets -->
      <div class="tab-header">
        <button class="tab-btn active" data-tab="text"><span class="material-symbols-outlined" style = "color:black;">
text_compare
</span> Text</button>
        <button class="tab-btn" data-tab="image"><span class="material-symbols-outlined" style = "color:black;">
wallpaper
</span> Image</button>
        <button class="tab-btn" data-tab="audio"><span class="material-symbols-outlined" style = "color:black;">
audio_description
</span> Audio</button>
      </div>

      <!-- Contenus des onglets -->
      <div class="tab-content">

        <!-- Texte -->
        <div class="tab-pane active" id="tab-text">
          <h3>Hide a Message in Text</h3>
          <input type="text" id="receiverUsernameSteg" placeholder="To (username)..." style="width: 80%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">

          <textarea id="textMessage" placeholder="Enter your text..." rows="5"></textarea>

          <div class="hidden-message-box">
            <h4>Hidden Message:</h4>
            <div class="hidden-message-display" id="hiddenMessageDisplay"></div>
            <button id="clearHiddenMessage" class="clear-btn"><span class="material-symbols-outlined" style = "margin: 0 !important;color:white;">
backspace
</span></button>
          </div>

          <button id="sendTextStegano">Send <span class="material-symbols-outlined">send</span></button>
        </div>

        <!-- Image -->
        <div class="tab-pane" id="tab-image">
          <h3>Hide a Message in an Image</h3>
          <input type="text" id="receiverUsernameSteg" placeholder="To (username)..." style="width: 80%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
          <input type="file" id="imageInput" accept="image/*"><br>
          <input type="text" id="imageHiddenText" placeholder="Enter text to hide"><br>
          <button id="sendImageStegano">Send <span class="material-symbols-outlined">send</span></button>
        </div>

        <!-- Audio -->
        <div class="tab-pane" id="tab-audio">
          <h3>Hide a Message in Audio</h3>
          <input type="text" id="receiverUsernameSteg" placeholder="To (username)..." style="width: 80%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
          <input type="file" id="audioInput" accept="audio/*"><br>
          <input type="text" id="audioHiddenText" placeholder="Enter text to hide"><br>
          <button id="sendAudioStegano">Send <span class="material-symbols-outlined">send</span></button>
        </div>
      </div>
    </div>
  `;

  // === Gestion des onglets ===
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabPanes = document.querySelectorAll('.tab-pane');

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      tabBtns.forEach(b => b.classList.remove('active'));
      tabPanes.forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
  });

// === Système de sélection de lettres (corrigé) ===
const textArea = document.getElementById('textMessage');
const hiddenDisplay = document.getElementById('hiddenMessageDisplay');

// Conteneur pour afficher les positions (compact)
let letterPosDisplay = document.getElementById('letterPosDisplay');
if (!letterPosDisplay) {
  letterPosDisplay = document.createElement('div');
  letterPosDisplay.id = "letterPosDisplay";
  letterPosDisplay.style.marginTop = "10px";
  letterPosDisplay.style.fontFamily = "monospace";
  letterPosDisplay.style.textAlign = "left";
  hiddenDisplay.after(letterPosDisplay);
}

let hiddenMessage = "";
let letterPositions = [];

textArea.addEventListener('mouseup', () => {
  // Récupère bornes de sélection dans le textarea
  const start = textArea.selectionStart;
  const end = textArea.selectionEnd;

  // On n'accepte que les sélections de 1 caractère
  if (typeof start === 'number' && typeof end === 'number' && end - start === 1) {
    const selectedChar = textArea.value.substring(start, end); // lettre sélectionnée
    hiddenMessage += selectedChar;
    letterPositions.push(start); // position (0-based)

    // Met à jour l'affichage
    hiddenDisplay.textContent = hiddenMessage;
    letterPosDisplay.innerHTML = `<strong>Lettre emplacement:</strong> ${letterPositions.join(",")}`;
  }
});

// === Bouton Effacer ===
document.getElementById('clearHiddenMessage').addEventListener('click', () => {
  hiddenMessage = "";
  letterPositions = [];
  hiddenDisplay.textContent = "";
  letterPosDisplay.innerHTML = "";
});



  // === Boutons Send ===
  document.getElementById('sendTextStegano').addEventListener('click', () => {
    const text = textArea.value.trim();
    if (!text) return alert("Please enter a message!");
    if (!hiddenMessage) return alert("Please select hidden letters first!");
    alert("Hidden message: " + hiddenMessage);
    sendSteganoText();
  });

  document.getElementById('sendImageStegano').addEventListener('click', () => {
    const img = document.getElementById('imageInput').files[0];
    const hidden = document.getElementById('imageHiddenText').value.trim();
    if (!img || !hidden) return alert("Please select an image and enter text!");
    alert("Image stegano message sent! (simulation)");
  });

  document.getElementById('sendAudioStegano').addEventListener('click', () => {
    const audio = document.getElementById('audioInput').files[0];
    const hidden = document.getElementById('audioHiddenText').value.trim();
    if (!audio || !hidden) return alert("Please select an audio file and enter text!");
    alert("Audio stegano message sent! (simulation)");
  });
});









  } catch (err) {
    console.error(err);
    alert("Erreur lors du chargement des messages reçus");
  }
});









/* ===========================
   STYLES SIMPLES POUR LES MSG
=========================== */
const style = document.createElement("style");
style.innerHTML = `
.message-box {
  border: 1px solid #ddd;
  background: #fff;
  border-radius: 8px;
  padding: 12px 15px;
  margin-bottom: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.decryptBtn {
  background: #007bff;
  color: #fff;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 6px;
}
.decryptBtn:hover { background: #0056b3; }
.decrypted { margin-top: 10px; padding: 8px; background: #f7f7f7; border-radius: 6px; }
`;
document.head.appendChild(style);

// ⚠️ SUPPRIMER ces deux lignes globales (elles réinitialisent à chaque fois)
//// let hiddenMessage = "";
//// let letterPositions = [];

// ✅ Version corrigée de sendSteganoText()
async function sendSteganoText() {
  const receiver = document.querySelector('#tab-text #receiverUsernameSteg').value.trim();
  const coverText = document.getElementById('textMessage').value.trim();

  // 🔥 Correction : on récupère les variables du scope de l'interface stéganographique
  const hiddenDisplay = document.getElementById('hiddenMessageDisplay');
  const letterPosDisplay = document.getElementById('letterPosDisplay');

  // ✅ On relit le message et les positions affichées à l’écran (au cas où le contexte global a disparu)
  const hiddenMessage = hiddenDisplay?.textContent?.trim() || "";
  const letterPositions = (letterPosDisplay?.textContent?.match(/\d+/g) || []).map(Number);

  if (!receiver) return alert("Please enter the recipient username!");
  if (!coverText) return alert("Please enter the visible text!");
  if (!hiddenMessage || letterPositions.length === 0)
    return alert("Please select hidden letters first!");

  try {
    const resUser = await fetch(`/api/user_id/${receiver}`, { credentials: 'include' });
    const dataUser = await resUser.json();
    if (!resUser.ok) return alert("Destinataire introuvable !");
    const receiverId = dataUser.id;

    const timestamp = Date.now();
    const sessionKey = (receiverId * timestamp) % 95;

    // Format meta : "positions|STEGANO-TEXT-UUID-999"
    const metaClear = `${letterPositions.join(",")}|STEGANO-TEXT-UUID-999`;
    const metaEnc = cesarChiffrement(metaClear, sessionKey);

    const payload = {
      to: receiver,
      content: coverText,
      hidden_text: hiddenMessage,
      meta: metaEnc,
      timestamp
    };
const res = await fetch('/api/send_message', {

    
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Erreur d'envoi");

    alert("Steganographic text message sent successfully!");

    // Réinitialisation locale
    document.getElementById('textMessage').value = "";
    hiddenDisplay.textContent = "";
    letterPosDisplay.innerHTML = "";

  } catch (err) {
    console.error(err);
    alert("Erreur : " + err.message);
  }
}





    async function sendEncryptedMessage(to, content) {
      const modal = document.getElementById('encryptionModal');
      const method = document.getElementById('popupEncryptionSelect').value;
      if (!method) return alert('Please select a method');

      const resUser = await fetch(`/api/user_id/${to}`, { credentials: 'include' });
      const dataUser = await resUser.json();
      if (!resUser.ok) return alert('Destinataire introuvable');
      const receiverId = dataUser.id;
      const now = new Date();
      const t = now.getTime();
      const sessionKey = (receiverId * t) % 95;
      let meta = null, encrypted = content;

      if (method === 'cesar') {
        const k = parseInt(document.getElementById('popupCesarKeyInput').value || 0);
        encrypted = cesarChiffrement(content, k);
        meta = cesarChiffrement(`${k}|CAESAR-UUID-001`, sessionKey);
      } else if (method === 'affine') {
        const a = parseInt(document.getElementById('popupAffineA').value || 1);
        const b = parseInt(document.getElementById('popupAffineB').value || 0);
        encrypted = affineChiffrement(content, a, b);
        meta = cesarChiffrement(`${a},${b}|AFFINE-UUID-777`, sessionKey);
      }else if (meta.includes("STEGANO-TEXT-UUID")) {
  // Exemple metaClear = "0,4,9|STEGANO-TEXT-UUID-999"
        const posPart = meta.split("|")[0];
       const positions = posPart.split(",").map(Number);
        let hidden = "";

  // Extraire les lettres selon les positions
        for (let pos of positions) {
        if (pos >= 0 && pos < contentEnc.length) {
         hidden += contentEnc[pos];
         }
         }

       decrypted = hidden || "[Aucun message caché trouvé]";
        type = "Stegano Text";
       } else if (method === 'hill') {
        const a = parseInt(document.getElementById('popupAffineA').value || 1);
        const b = parseInt(document.getElementById('popupAffineB').value || 0);
        encrypted = affineChiffrement(content, a, b);
        meta = cesarChiffrement(`${a},${b}|HILL-UUID-777`, sessionKey);
      } else if (method === 'playfair') {
        const a = parseInt(document.getElementById('popupAffineA').value || 1);
        const b = parseInt(document.getElementById('popupAffineB').value || 0);
        encrypted = affineChiffrement(content, a, b);
        meta = cesarChiffrement(`${a},${b}|PLAYFAIR-UUID-777`, sessionKey);
      }

      const res = await fetch('/api/send_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ to, content: encrypted, meta, timestamp: t })
      });

      const data = await res.json();
      modal.style.display = 'none';
      alert(res.ok ? 'Message envoyé avec chiffrement !' : data.error || 'Erreur envoi');
    }

    function attachSendHandler() {
      document.getElementById('sendMessageForm').addEventListener('submit', e => {
        e.preventDefault();
        const to = document.getElementById('to').value.trim();
        const content = document.getElementById('content').value.trim();
        if (!to || !content) return alert('Recipient and content required');
        openEncryptionPopup(to, content);
      });
    }




    // === LOGOUT HANDLER ===
document.getElementById("logoutBtn").addEventListener("click", async () => {
  if (!confirm("Voulez-vous vraiment vous déconnecter ?")) return;

  try {
    const res = await fetch("/logout", {
      method: "POST",
      credentials: "include", // très important pour envoyer les cookies JWT
    });

    if (res.ok) {
      alert("Déconnexion réussie !");
      // Redirige vers la page de connexion (ou d'accueil)
      window.location.href = "/";
    } else {
      const err = await res.json();
      alert("Erreur lors de la déconnexion : " + (err.msg || "inconnue"));
    }
  } catch (error) {
    console.error("Erreur logout :", error);
    alert("Erreur réseau ou serveur pendant la déconnexion.");
  }
});

  </script>
</body>
</html>
